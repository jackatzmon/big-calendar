<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Big Calendar Pairing</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 24px; max-width: 720px; margin: 0 auto; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
      input { width: 100%; padding: 12px; font-size: 16px; margin: 6px 0 12px; }
      button { padding: 12px 16px; font-size: 16px; cursor: pointer; }
      .row { display: flex; gap: 10px; align-items: center; }
      .row > * { flex: 1; }
      .muted { color: #666; }
      .error { color: #b00020; }
      .ok { color: #0a7a0a; }
      code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    </style>
  </head>

  <body>
    <h1>Connect calendars</h1>

    <div class="card">
      <h2>Pairing code</h2>
      <p class="muted">Enter the 4-letter code shown on your TV.</p>
      <input id="codeInput" placeholder="e.g. M4XF" />
      <div class="row">
        <button id="useCodeBtn">Use code</button>
        <button id="openWithCodeBtn">Open with code</button>
      </div>
      <p id="codeStatus" class="muted"></p>
    </div>

    <div class="card">
      <h2>Apple iCloud Calendar</h2>
      <p class="muted">
        Recommended: paste an iCloud <b>Public Calendar</b> link (ends in <code>.ics</code>). This is read-only.
      </p>
      <input id="icsUrl" placeholder="Paste iCloud public .ics link here" />
      <button id="saveIcsBtn">Save iCloud .ics link</button>
      <p id="icsStatus" class="muted"></p>
    </div>

    <div class="card">
      <h2>Status</h2>
      <p id="status" class="muted">Not paired yet.</p>
    </div>

    <script>
      // ---- config ----
      const API_BASE = "https://us-central1-big-calendar-1e6a8.cloudfunctions.net/api";

      // ---- helpers ----
      const qs = new URLSearchParams(location.search);
      const el = (id) => document.getElementById(id);

      function currentCode() {
        const c = (el("codeInput").value || "").trim().toUpperCase();
        return c;
      }

      function setFromUrl() {
        const fromUrl = (qs.get("code") || "").trim().toUpperCase();
        if (fromUrl) {
          el("codeInput").value = fromUrl;
          el("codeStatus").textContent = "Code loaded from URL: " + fromUrl;
        } else {
          el("codeStatus").innerHTML = '<span class="error">Missing pairing code.</span> Enter the code from the TV above.';
        }
      }

      async function getStatus() {
        const code = currentCode();
        if (!code) {
          el("status").innerHTML = '<span class="error">Missing pairing code.</span>';
          return;
        }
        try {
          const r = await fetch(`${API_BASE}/pair/status?code=${encodeURIComponent(code)}`);
          const txt = await r.text();
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${txt}`);
          const data = JSON.parse(txt);
          el("status").innerHTML = `<span class="ok">Paired:</span> ${data.status} â€” connected: ${(data.connectedProviders||[]).join(", ") || "none"}`;
        } catch (e) {
          el("status").innerHTML = `<span class="error">Error:</span> ${e.message}`;
        }
      }

      async function saveIcs() {
        const code = currentCode();
        const url = (el("icsUrl").value || "").trim();
        if (!code) {
          el("icsStatus").innerHTML = '<span class="error">Missing pairing code.</span> Enter it above first.';
          return;
        }
        if (!url) {
          el("icsStatus").innerHTML = '<span class="error">Missing .ics link.</span>';
          return;
        }
        try {
          const r = await fetch(`${API_BASE}/calendars/icloud/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code, icsUrl: url })
          });
          const txt = await r.text();
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${txt}`);
          el("icsStatus").innerHTML = `<span class="ok">Saved.</span> iCloud calendar link added.`;
          await getStatus();
        } catch (e) {
          el("icsStatus").innerHTML = `<span class="error">Error:</span> ${e.message}`;
        }
      }

      // ---- wire up ----
      el("useCodeBtn").onclick = async () => {
        const code = currentCode();
        if (!code) {
          el("codeStatus").innerHTML = '<span class="error">Enter the code.</span>';
          return;
        }
        // Update URL without reloading
        const newUrl = `${location.pathname}?code=${encodeURIComponent(code)}`;
        history.replaceState({}, "", newUrl);
        el("codeStatus").textContent = "Using code: " + code;
        await getStatus();
      };

      el("openWithCodeBtn").onclick = () => {
        const code = currentCode();
        if (!code) {
          el("codeStatus").innerHTML = '<span class="error">Enter the code.</span>';
          return;
        }
        location.href = `${location.pathname}?code=${encodeURIComponent(code)}`;
      };

      el("saveIcsBtn").onclick = saveIcs;

      // init
      setFromUrl();
      getStatus();
    </script>
  </body>
</html>
